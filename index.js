(()=>{"use strict";const e=new URL("https://nf-api.onrender.com/api/v1").toString(),t=e=>{try{return JSON.parse(localStorage.getItem(e))}catch{return null}},o=e=>{const o=t("token"),n={};return e&&(n["Content-Type"]=e),o&&(n.Authorization=`Bearer ${o}`),n},n=(e,t)=>{localStorage.setItem(e,JSON.stringify(t))};async function r(t,r){const a=await fetch(`${e}/social/auth/login`,{method:"post",body:JSON.stringify({email:t,password:r}),headers:o("application/json")});if(a.ok){const e=await a.json();return n("token",e.accessToken),delete e.accessToken,n("profile",e),e}throw new Error(a.statusText)}const a=e=>localStorage.removeItem(e),s=()=>Boolean(t("token")),c=()=>t("profile"),i=()=>{const e=new URL(window.location);return Object.fromEntries(e.searchParams)},l=(e="404")=>{const t=document.querySelector(`template#${e}`);if(t)return t.content.cloneNode(!0);throw new Error(`Template #${e} not found`)};function d(e){for(;e.firstChild;)e.removeChild(e.firstChild)}const u=e=>{const t=document.createElement("a");t.classList.add("profile","thumbnail"),t.href=`/?view=profile&name=${e.name}`;const o=new Image;return o.src=e.avatar||"https://cdn.discordapp.com/attachments/931268688412299274/1026475050578231376/no-user-image-icon-0.jpg",o.alt=e.name,o.classList.add("rounded-circle","avatar","border"),t.title=`${e.name}'s Profile`,t.append(o),t},m=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘","😗","😙","😚","☺","🙂","🤗","🤔","😐","😑","😶","🙄","😏","😣","😥","😮","🤐","😯","😪","😫","😴","😌","🤓","😛","😜","😝","🤤","😒","😓","😔","😕","🙃","🤑","😲","☹","🙁","😖","😞","😟","😤","😢","😭","😦","😧","😨","😩","😬","😰","😱","😳","😵","😡","😠","😇","🤠","🤡","🤥","😷","🤒","🤕","🤢","🤧"];function p(){const e=t("token");document.body.classList[e?"add":"remove"]("logged-in")}function f(){a("token"),a("profile"),p(),window.location.href="/"}async function w(t){const n=t.srcElement,r=n.dataset.symbol,a=n.dataset.postId;a&&r&&(await async function(t,n){const r=await fetch(`${e}/social/posts/${t}/react/${n}`,{headers:o(),method:"put"});if(r.ok)return await r.json();throw new Error(r.statusText)}(a,r),location.reload())}async function y(t){t.preventDefault();const n=t.target,r=new FormData(n).get("body"),a=n.dataset.postId,s=i().replyToId;await async function(t,n,r){const a=await fetch(`${e}/social/posts/${t}/comment`,{method:"post",body:JSON.stringify({body:n,replyToId:r}),headers:o("application/json")});if(a.ok)return await a.json();throw new Error(a.statusText)}(a,r,s),n.remove(),location.reload()}async function h(t){const n=t.srcElement.dataset.name;n&&(await async function(t){const n=await fetch(`${e}/social/profiles/${t}/follow`,{headers:o(),method:"put"});if(n.ok)return await n.json();throw new Error(n.statusText)}(n),location.reload())}async function g(t){const n=t.srcElement.dataset.name;n&&(await async function(t){const n=await fetch(`${e}/social/profiles/${t}/unfollow`,{headers:o(),method:"put"});if(n.ok)return await n.json();throw new Error(n.statusText)}(n),location.reload())}const S=({symbol:e,count:t,postId:o})=>{const n=l("reactionButton");return n.querySelector(".btn").dataset.symbol=e,n.querySelector(".btn").prepend(`${e}`),n.querySelector(".badge").innerText=t,n.querySelector(".btn").dataset.postId=o,n},v=(e,t)=>{const o=l("reactionOption");return o.querySelector(".dropdown-item").dataset.symbol=e,o.querySelector(".dropdown-item").dataset.postId=t,o.querySelector(".dropdown-item").innerText=e,o},q=(n,r=!1)=>{const a=l("postThumbnail");a.querySelector(".post").id=n.id;const s=(e=>{const t=l("postHeader");t.querySelector(".card-header").href=`/?view=post&postId=${e.id}`,t.querySelector("b").innerText=e.title,e.body?t.querySelector("span").innerText=e.body:t.querySelector("span").remove();const o=(e=>{if(e&&e.length){const t=l("commentsTag");return t.querySelector(".badge").innerText=`${e.length} comment${e.length>1?"s":""}`,t}return"\r\n"})(e.comments),n=(e=>{if(e.tags){const t=document.createElement("span");t.classList.add("post-tags");const o=e.tags.map((e=>{const t=l("postTag");return t.querySelector(".badge").innerText=e,t}));return t.append(...o),t}return"\r\n"})(e),r=[o,n];return e.author&&r.push(u(e.author)),t.querySelector(".card-header").append(...r),t})(n),c=((e,t="a")=>{if(e.media){const o=document.createElement(t);o.classList.add("card-img");const n=new Image;return n.src=e.media,n.alt=e.title,n.classList.add("img-fluid","w-100"),"a"===t.toLowerCase()&&(o.href=`/?view=post&postId=${e.id}`,o.title=`View ${e.title}`),o.append(n),o}return"\r\n"})(n,r?"div":"a"),d=function(){const e=l("postFooter");return e.querySelector(".card-footer").append(...arguments),e}((n=>{const r=t("profile"),a=l("postActions"),s=n.author&&r.name===n.author.name,{postId:c}=i(),d=c==n.id,u=a.querySelector("a[data-action=view]"),m=a.querySelector("button[data-action=delete]");return d?u.remove():u.href=`/?view=post&postId=${n.id}`,s?m.addEventListener("click",(async()=>{await async function(t){const n=await fetch(`${e}/social/posts/${t}`,{method:"delete",headers:o()});if(n.ok)return await n.json();throw new Error(n.statusText)}(n.id),location.href="/"})):m.remove(),a})(n),(e=>{const t=l("reactionMenu");if(e.reactions&&e.reactions.length){const o=e.reactions.sort(((e,t)=>t.count-e.count)).map((e=>S(e)));t.querySelector(".reactions").prepend(...o)}const o=((e=[])=>m.filter((t=>!e.map((e=>e.symbol)).includes(t))))(e.reactions);return t.querySelector(".dropdown-menu").append(...o.map((t=>v(t,e.id)))),t.querySelectorAll("[data-reaction]").forEach((e=>{e.addEventListener("click",w)})),t})(n)),p=[s,c,d];return a.querySelector(".thumbnail").append(...p),a};function b(e,t){const o=q(e,!1);d(t),t.append(o)}const T=t=>{const n=l("postForm"),r=n.querySelector("#postForm"),a=n.querySelector("[data-action=submit]"),s=n.querySelector("#postPreview");return t&&t.id?(function(e,t){t.title.value=e.title,t.body.value=e.body,t.media.value=e.media,t.tags.value=e.tags.join(", ")}(t,r),b(t,s),a.querySelector("[data-action=publish]").style.display="none"):a.querySelector("[data-action=update]").style.display="none",r.addEventListener("input",(()=>{b({title:r.title.value,body:r.body.value,media:r.media.value,tags:r.tags.value.split(", ")},s)})),r.addEventListener("submit",(async t=>{t.preventDefault();const n=new URL(location.href).searchParams.get("postId"),r=t.target,a=new FormData(r),s=a.get("title"),i=a.get("body"),l=a.get("media"),d=a.get("tags").split(", ");let u;u=n?await async function(t,n,r,a,s){const{name:i}=c(),l=await fetch(`${e}/social/posts/${t}`,{method:"put",body:JSON.stringify({title:n,body:r,media:a,tags:s,owner:i}),headers:o("application/json")});if(l.ok)return await l.json();throw new Error(l.statusText)}(n,s,i,l,d):await async function(t,n,r,a){const s=await fetch(`${e}/social/posts/`,{method:"post",body:JSON.stringify({title:t,body:n,media:r,tags:a}),headers:o("application/json")});if(s.ok)return await s.json();throw new Error(s.statusText)}(s,i,l,d),location.href=`/?view=post&postId=${u.id}`})),n},E=e=>{const t=document.createElement("div");if(t.classList.add("post-comments"),e&&e.comments){const o=e.comments.map((t=>((e,t="")=>{const{name:o}=c(),n=l("comment");n.querySelector(".comment-body").innerText=e.body,n.querySelector(".owner").innerText=e.owner,n.querySelector(".owner").href=`/?view=profile&name=${e.owner}`;const r=document.createElement("button");return r.classList.add("btn","btn-sm","btn-success"),r.innerText="Reply",r.addEventListener("click",(()=>{(e=>{const t={...i(),...e},o=new URLSearchParams(t);window.location.search=o.toString()})({replyToId:e.id})})),n.querySelector(".comment-header").prepend(r),o===e.owner&&n.querySelector(".comment").classList.add("me"),o===t&&n.querySelector(".comment").classList.add("op"),n})(t,e.author.name)));t.append(...o)}return t.append((e=>{const t=l("commentForm");return t.querySelector("form").dataset.postId=e,t.querySelector("form").addEventListener("submit",y),t})(e.id)),t},$={title:"Loading...",body:"",tags:["please","wait"],media:"",reactions:[{symbol:"⌛",count:1,postId:0}],comments:[{body:"",replyToId:0,id:0,postId:0,owner:"",created:"2022-09-05T19:33:29.154Z"}],created:"2022-09-05T19:33:29.154Z",updated:"2022-09-05T19:33:29.154Z",id:0,author:{name:"",email:"",avatar:"/assets/img/avatar.jpeg"},_count:{comments:0,reactions:0}},L=(e={})=>{e={...$,...e};const t=q(e);return t.querySelector(".post").classList.add("loader"),t},k=e=>{const t=l("profileButton");return t.querySelector("img").src=e.avatar,t.querySelector(".btn").innerText=e.name,t.querySelector("a").href=`/?view=profile&name=${e.name}`,t},x=(e,t=!1)=>{const o=document.createElement("div");return o.classList.add("post","list"),o.append(...e.map((e=>q(e,t)))),o},I=e=>{if(e&&e.followers&&e.followers.length){const t=document.createElement("div");return t.classList.add("followers"),t.append("Followers",...e.followers.map(u)),t}return"\r\n"},j=e=>{if(e.following&&e.following.length){const t=document.createElement("div");return t.classList.add("following"),t.append("Following",...e.following.map(u)),t}return"\r\n"};function F(){const e=document.querySelector("main");d(e),e.append(...arguments)}const _=async t=>{if(s())return(e=>{const t=l("profilePagePrivate"),{name:o}=c();if(t.querySelector("img.avatar").src=e.avatar,t.querySelector(".profile-name").innerText=e.name,t.querySelector(".profile-email").innerText=e.email,t.querySelector(".upper").prepend((e=>{const t=document.createElement("div");t.classList.add("profile","follows");const o=[I(e),j(e)];return t.append(...o),t})(e)),e.posts&&e.posts.length){const o=x(e.posts);t.querySelector(".profile-posts").append(o)}else{const e=document.createElement("div");e.classList.add("alert","alert-info"),e.innerText="There are no posts yet...",t.querySelector(".profile-posts").append(e)}return e.name!==o?e.followers.find((e=>e.name===o))?(t.querySelector("[data-action=follow]").remove(),t.querySelector("[data-action=unfollow]").dataset.name=e.name,t.querySelector("[data-action=unfollow]").addEventListener("click",g)):(t.querySelector("[data-action=unfollow]").remove(),t.querySelector("[data-action=follow]").dataset.name=e.name,t.querySelector("[data-action=follow]").addEventListener("click",h)):(t.querySelector("[data-action=follow]").remove(),t.querySelector("[data-action=unfollow]").remove()),t})(await async function(t){const n=await fetch(`${e}/social/profiles/${t}?&_followers=true&_posts=true&_following=true`,{headers:o()});if(n.ok)return await n.json();throw new Error(n.statusText)}(t));location.href="/"};function O(e=(()=>{}),t=""){if(s())return e();{t&&(location.href="/"),document.querySelector("[data-auth=register]").click();const e=document.createElement("div");return e.classList.add("alert","alert-warning"),e.innerText="Please register or login to view this page.",e}}async function D(){const{view:r,postId:a,name:d}=i();switch(r){case"post":return O((()=>(F(L()),(async t=>{if(s()){const n=c();if(t){const r=await async function(t){const n=await fetch(`${e}/social/posts/${t}?_reactions=true&_author=true&_comments=true`,{headers:o()});if(n.ok)return await n.json();throw new Error(n.statusText)}(t);if(r.author.name===n.name){const e=l("postTabs"),t=q(r),o=T(r),n=E(r);return e.querySelector("#nav-default").append(t,n),e.querySelector("#nav-edit").append(o),e}return(async e=>{const t=document.createElement("div");t.classList.add("post","page","mb-3");const o=q(e,!0),n=E(e);return t.append(o,n),t})(r)}return T()}location.href="/"})(a))),r);case"profile":return O((()=>_(d)),r);case"profiles":return O((async()=>(async e=>{const t=document.createElement("div");return t.classList.add("profile","list"),t.append(...e.map((e=>k(e)))),t})(await async function(){const t=await fetch(`${e}/social/profiles`,{headers:o()});if(t.ok)return await t.json();throw new Error(t.statusText)}())),r);default:return O((async()=>{F(...Array.from({length:t("posts:lastTime")||3},(()=>L())));const r=await async function(t=20,n=0){const r=await fetch(`${e}/social/posts?limit=${t}&offset=${n}&_reactions=true&_author=true&_comments=true`,{headers:o()});if(r.ok)return await r.json();throw new Error(r.statusText)}();return n("posts:lastTime",r.length),x(r)}),r)}}document.querySelectorAll("[data-auth=logout]").forEach((e=>e.addEventListener("click",f))),document.querySelector("form#loginForm").addEventListener("submit",(async function(e){e.preventDefault();const t=e.target,o=new FormData(t),n=o.get("email"),a=o.get("password"),{name:s}=await r(n,a);p(),location.href=`/?view=profile&name=${s}`})),document.querySelector("form#registerForm").addEventListener("submit",(async function(t){t.preventDefault();const n=t.target,a=new FormData(n),s=a.get("email"),c=a.get("name"),i=a.get("password"),l=a.get("avatar");await async function(t,n,r,a){const s=await fetch(`${e}/social/auth/register`,{method:"post",body:JSON.stringify({name:t,email:n,password:r,avatar:a}),headers:o("application/json")});if(s.ok)return await s.json();throw new Error(s.statusText)}(c,s,i,l),await r(s,i),location.reload()})),(()=>{const e=document.querySelector("footer").querySelector("#footerActions");if(s()){const o=t("profile");e.prepend(k(o))}})(),p(),(async()=>{F(await D())})()})();